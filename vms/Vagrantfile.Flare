Vagrant.configure("2") do |config|
  config.vm.define "FlareVM" do |flare|
    flare.vm.box = "peru/windows-10-enterprise-x64-eval"
    flare.vm.box_version = "20231001.01"

    # Set the VM provider to libvirt with KVM driver
    flare.vm.provider "libvirt" do |libvirt|
      libvirt.driver = "kvm"
      libvirt.memory = 8192  # 8 GB of RAM
      libvirt.cpus = 2       # 2 CPU cores

      # Configure an 80 GB virtual hard disk
      libvirt.storage :file, :size => '80G', :device => 'sda', :bus => 'sata', :path => '/var/lib/libvirt/images/FlareVM.qcow2'
    end

    # Provisioning script to install Chocolatey, disable Windows updates, UAC, and modify Windows Defender settings
    flare.vm.provision "shell", inline: <<-SHELL
      # Install Chocolatey
      Set-ExecutionPolicy Bypass -Scope Process -Force; [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('https://chocolatey.org/install.ps1'))

      # Disable Windows updates
      Stop-Service -Name "wuauserv" -Force
      Set-Service -Name "wuauserv" -StartupType Disabled

      # Disable UAC
      Set-ItemProperty -Path "HKLM:\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\Policies\\System" -Name "EnableLUA" -Value 0

      # Modify Windows Defender settings
      Set-MpPreference -DisableRealtimeMonitoring $true
      Set-MpPreference -MAPSReporting 0
      New-ItemProperty -Path "HKLM:\\SOFTWARE\\Policies\\Microsoft\\Windows Defender" -Name DisableAntiSpyware -Value 1 -PropertyType DWORD -Force
      Uninstall-WindowsFeature -Name Windows-Defender

      # Set keyboard layout to Swiss German
      Set-WinUserLanguageList -LanguageList 'de-CH' -Force

      # Set time format to 24-hour
      Set-ItemProperty -Path 'HKCU:\Control Panel\International' -Name 'sTimeFormat' -Value 'HH:mm:ss'

      # Download and run Flare-VM installation script
      (New-Object net.webclient).DownloadFile('https://raw.githubusercontent.com/mandiant/flare-vm/main/install.ps1',"install.ps1")
      Unblock-File .\\install.ps1
      Set-ExecutionPolicy Unrestricted -Force
      .\\install.ps1 -password malware -noWait -noGui -customConfig soc.xml
    SHELL
  end
end
